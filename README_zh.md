# FastAPI æ¨¡æ¿

ä¸€ä¸ªå¥å£®ã€æ¨¡å—åŒ–ä¸”å…·æœ‰æ˜ç¡®æ¶æ„çš„ FastAPI é¡¹ç›®æ¨¡æ¿ï¼Œæ—¨åœ¨æ„å»ºå¯æ‰©å±•çš„ä¸šåŠ¡åº”ç”¨ç¨‹åºã€‚

## ğŸŒŸ ç‰¹æ€§

- **æ¨¡å—åŒ–æ¶æ„**: å— DDD (é¢†åŸŸé©±åŠ¨è®¾è®¡) å¯å‘çš„ç»“æ„ï¼Œæ˜ç¡®åˆ’åˆ†äº†èŒè´£ (`api`, `core`, `services`, `lifespan`)ã€‚
- **è‡ªå®šä¹‰ä¾èµ–æ³¨å…¥**: ä¸€ä¸ªå¼ºå¤§çš„ `ServiceContainer`ï¼Œæ”¯æŒ:
    - **å•ä¾‹ä¸ç¬æ€ç”Ÿå‘½å‘¨æœŸ**: ç®¡ç†èµ„æºå¯†é›†å‹å¯¹è±¡ (å¦‚æ•°æ®åº“è¿æ¥æ± ) ä¸æŒ‰è¯·æ±‚åˆ›å»ºçš„å¯¹è±¡ã€‚
    - **å¼‚æ­¥ç”Ÿæˆå™¨**: éå¸¸é€‚åˆéœ€è¦è®¾ç½®/æ‹†å¸ä¸Šä¸‹æ–‡çš„èµ„æº (å¦‚ä¼šè¯)ã€‚
    - **å»¶è¿ŸåŠ è½½**: æœåŠ¡ä»…åœ¨è¢«è¯·æ±‚æ—¶ (æˆ–åœ¨ç”Ÿå‘½å‘¨æœŸä¸­æ˜ç¡®) æ‰åˆå§‹åŒ–ã€‚
- **é«˜çº§æ—¥å¿—**: é¢„é…ç½® `loguru` é›†æˆï¼Œæ”¯æŒæ—¥å¿—è½®è½¬ã€ä¿ç•™å’Œæ ‡å‡†åº“æ‹¦æˆªã€‚
- **é…ç½®ç®¡ç†**: ä½¿ç”¨ `pydantic-settings` è¿›è¡Œç±»å‹å®‰å…¨çš„é…ç½®ï¼Œå¹¶æ”¯æŒ `.env` æ–‡ä»¶ã€‚
- **API ç‰ˆæœ¬æ§åˆ¶**: å†…ç½®æ”¯æŒç‰ˆæœ¬åŒ–çš„ API (`/api/v1/...`)ã€‚

## ğŸ“‹ å…ˆå†³æ¡ä»¶

- **Python**: >= 3.12
- **åŒ…ç®¡ç†å™¨**: [uv](https://github.com/astral-sh/uv) (æ¨è) æˆ– pip

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…

å…‹éš†ä»“åº“å¹¶å®‰è£…ä¾èµ–:

```bash
uv sync
```

### 2. é…ç½®

åº”ç”¨ç¨‹åºä½¿ç”¨ `pydantic-settings`ã€‚ä½ å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æˆ– `.env` æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶:

```ini
DEBUG_MODE = true
LOG_DIR = ./log
APP_NAME = "FastAPI Template"
APP_VERSION = "0.1.0"
```

### 3. è¿è¡Œåº”ç”¨ç¨‹åº

ä½¿ç”¨ `uvicorn` æˆ– `fastapi` CLI è¿è¡Œåº”ç”¨ç¨‹åº:

```bash
# å¼€å‘æ¨¡å¼
uv run fastapi dev app/main.py

# ç”Ÿäº§æ¨¡å¼
uv run uvicorn app.main:app --host 0.0.0.0 --port 8000
```

API å°†åœ¨ `http://localhost:8000` å¯ç”¨ã€‚
API æ–‡æ¡£ (Swagger UI) åœ¨ `http://localhost:8000/docs`ã€‚

## ğŸ§ª æµ‹è¯•

æ­¤æ¨¡æ¿åŒ…å«ä½¿ç”¨ `pytest` å’Œ `TestClient` çš„æµ‹è¯•è®¾ç½®ã€‚

1. **å®‰è£…æµ‹è¯•ä¾èµ–**:
   *(ç¡®ä¿ `pytest` å’Œ `httpx` å·²å®‰è£…åœ¨ä½ çš„ç¯å¢ƒä¸­)*
   ```bash
   uv add --dev pytest httpx
   ```

2. **è¿è¡Œæµ‹è¯•**:
   ```bash
   uv run pytest
   ```

## ğŸ— æ¶æ„æ¦‚è§ˆ

### æœåŠ¡å®¹å™¨ (`app/core/dependencies.py`)

æ­¤æ¨¡æ¿çš„æ ¸å¿ƒæ˜¯è‡ªå®šä¹‰çš„ `ServiceContainer`ã€‚ä¸æ ‡å‡†çš„ FastAPI `Depends` ä¸åŒï¼Œæ­¤å®¹å™¨å…è®¸:

- **è§£è€¦é€»è¾‘**: æœåŠ¡æ— éœ€äº†è§£ FastAPI `Request` å¯¹è±¡ã€‚
- **å¤æ‚çš„ç”Ÿå‘½å‘¨æœŸ**: è‡ªåŠ¨å¤„ç†ç¬æ€æœåŠ¡åœ¨è¯·æ±‚ç»“æŸæ—¶çš„æ¸…ç† (dtor)ã€‚

**å¦‚ä½•ä½¿ç”¨:**

1. **å®šä¹‰æœåŠ¡**: ç»§æ‰¿è‡ª `BaseService`ã€‚
2. **åœ¨ç”Ÿå‘½å‘¨æœŸä¸­æ³¨å†Œ** (`app/lifespan/main.py`):
   ```python
   await app.state.services.register(
       "my_service",
       ServiceLifetime.TRANSIENT,
       MyService.LifespanTasks.ctor,
       MyService.LifespanTasks.dtor
   )
   ```
3. **åœ¨ API ä¸­æ³¨å…¥**:
   ```python
   @router.get("/")
   async def endpoint(svc: MyService = inject("my_service")):
       ...
   ```

### æ–‡ä»¶å¤¹ç»“æ„

```
app/
â”œâ”€â”€ api/            # è·¯ç”±å¤„ç†ç¨‹åº (æ§åˆ¶å™¨)
â”‚   â””â”€â”€ v1/         # API ç‰ˆæœ¬ 1
â”œâ”€â”€ core/           # æ ¸å¿ƒåŸºç¡€è®¾æ–½ (ä¾èµ–æ³¨å…¥, æ—¥å¿—, é…ç½®)
â”œâ”€â”€ lifespan/       # åº”ç”¨ç¨‹åºå¯åŠ¨/å…³é—­é€»è¾‘
â”œâ”€â”€ middleware/     # è‡ªå®šä¹‰ä¸­é—´ä»¶
â”œâ”€â”€ services/       # ä¸šåŠ¡é€»è¾‘ (é¢†åŸŸå±‚)
â””â”€â”€ main.py         # åº”ç”¨ç¨‹åºå…¥å£
```

## ğŸ›  å¼€å‘

- **ä»£ç æ£€æŸ¥ (Linting)**: æ¨èé…ç½® `ruff`ã€‚
- **ä»£ç æ ¼å¼åŒ– (Formatting)**: æ¨èé…ç½® `ruff` æˆ– `black`ã€‚
